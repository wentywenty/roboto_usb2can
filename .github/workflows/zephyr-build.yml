name: Zephyr Build

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Zephyr SDK
        uses: actions/cache@v4
        with:
          path: ~/zephyr-sdk-0.17.4
          key: zephyr-sdk-0.17.4-linux
          restore-keys: zephyr-sdk-

      - name: Cache Python venv
        uses: actions/cache@v4
        with:
          path: ~/venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: venv-${{ runner.os }}-

      - name: Cache Zephyr workspace
        uses: actions/cache@v4
        with:
          path: ~/work
          key: zephyr-workspace-${{ hashFiles('west.yml') }}
          restore-keys: zephyr-workspace-

      - name: Install system dependencies
        run: sudo apt update && sudo apt install -y ninja-build cmake python3-pip python3-venv git ccache

      - name: Setup Python venv
        run: |
          python3 -m venv ~/venv
          ~/venv/bin/python -m pip install --upgrade pip west

      - name: Initialize west workspace
        run: |
          ~/venv/bin/west init -m $GITHUB_WORKSPACE ~/work
          cd ~/work
          ~/venv/bin/west update

      - name: Setup Zephyr environment
        run: |
          cd ~/work
          ~/venv/bin/west zephyr-export
          ~/venv/bin/west packages pip --install

      - name: Install Zephyr SDK
        run: |
          if [ ! -d ~/zephyr-sdk-0.17.4 ]; then
            wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.17.4/zephyr-sdk-0.17.4_linux-x86_64.tar.xz -O /tmp/sdk.tar.xz
            tar xf /tmp/sdk.tar.xz -C ~/
            rm /tmp/sdk.tar.xz
          fi
          ~/zephyr-sdk-0.17.4/setup.sh -t arm-zephyr-eabi -h

      - name: Build roboto_usb2can
        run: |
          cd ~/work/samples/roboto_usb2can
          export ZEPHYR_SDK_INSTALL_DIR=~/zephyr-sdk-0.17.4
          ~/venv/bin/west build -b roboto_usb2can -- -DCMAKE_BUILD_TYPE=Release
